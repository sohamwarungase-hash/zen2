// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum ComplaintStatus {
  PENDING
  AI_ANALYSIS
  ASSIGNED
  IN_PROGRESS
  RESOLVED
  CLOSED
  REJECTED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model User {
  id             String      @id @default(uuid()) @db.Uuid
  email          String      @unique
  name           String?
  complaints     Complaint[]
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@map("users")
}

model Zone {
  id             String       @id @default(uuid()) @db.Uuid
  name           String       @unique
  boundary       Json?        // To store polygon/bounding-box geoJSON or simple coords
  departments    Department[]
  complaints     Complaint[]
  createdAt      DateTime     @default(now())

  @@map("zones")
}

model Department {
  id             String       @id @default(uuid()) @db.Uuid
  name           String
  zone           Zone         @relation(fields: [zoneId], references: [id])
  zoneId         String       @db.Uuid
  assignments    Assignment[]
  createdAt      DateTime     @default(now())

  @@unique([name, zoneId])
  @@map("departments")
}

model Complaint {
  id               String          @id @default(uuid()) @db.Uuid
  description      String          @db.Text
  category         String          // Original category provided by user
  photoUrl         String?
  latitude         Float
  longitude        Float
  status           ComplaintStatus @default(PENDING)
  priority         Priority?
  
  // Relations
  user             User            @relation(fields: [userId], references: [id])
  userId           String          @db.Uuid
  zone             Zone?           @relation(fields: [zoneId], references: [id])
  zoneId           String?         @db.Uuid
  
  aiAnalysis       AiAnalysis?
  assignments      Assignment[]
  
  // SLA tracking
  assignedAt       DateTime?
  resolvedAt       DateTime?
  
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([status])
  @@index([latitude, longitude])
  @@index([createdAt])
  @@map("complaints")
}

model AiAnalysis {
  id                    String    @id @default(uuid()) @db.Uuid
  complaint             Complaint @relation(fields: [complaintId], references: [id])
  complaintId           String    @unique @db.Uuid
  
  departmentPrediction  String
  severityScore         Int       // 1-10
  locationSensitivity   Int       // 1-10
  publicRiskScore       Int       // 1-10
  envImpactScore        Int       // 1-10
  priorityScore         Float
  priorityLevel         Priority
  analyticsTags         String[]
  confidence            Float     // 0-1
  rawAiOutput           Json?     // store the original AI response for debugging
  
  createdAt             DateTime  @default(now())

  @@map("ai_analysis")
}

model Assignment {
  id             String      @id @default(uuid()) @db.Uuid
  complaint      Complaint   @relation(fields: [complaintId], references: [id])
  complaintId    String      @db.Uuid
  department     Department  @relation(fields: [departmentId], references: [id])
  departmentId   String      @db.Uuid
  
  assignedAt     DateTime    @default(now())
  notes          String?

  @@index([complaintId])
  @@index([departmentId])
  @@map("assignments")
}
