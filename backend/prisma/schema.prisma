// ==========================
// Prisma Client
// ==========================
generator client {
  provider = "prisma-client-js"
}

// ==========================
// Database
// ==========================
datasource db {
  provider = "postgresql"
}

// ==========================
// Enums
// ==========================
enum ComplaintStatus {
  PENDING
  AI_ANALYSIS
  ASSIGNED
  IN_PROGRESS
  RESOLVED
  CLOSED
  REJECTED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ==========================
// Models
// ==========================

model Zone {
  id          String       @id @default(uuid()) @db.Uuid
  name        String       @unique

  // GeoJSON stored as JSON
  boundary    Json?

  departments Department[]
  complaints  Complaint[]

  createdAt  DateTime     @default(now())

  @@map("zones")
}

model Department {
  id          String       @id @default(uuid()) @db.Uuid
  name        String

  zone        Zone         @relation(fields: [zoneId], references: [id])
  zoneId      String       @db.Uuid

  assignments Assignment[]

  createdAt  DateTime     @default(now())

  @@unique([name, zoneId])
  @@map("departments")
}

model Complaint {
  id          String          @id @default(uuid()) @db.Uuid

  description String          @db.Text
  category    String
  address     String?
  photoUrl    String?

  latitude    Float
  longitude   Float

  status      ComplaintStatus @default(PENDING)
  priority    Priority?

  // Citizen contact info (no account needed)
  citizenName   String?
  citizenEmail  String?
  citizenPhone  String?

  // Relations
  zone        Zone?           @relation(fields: [zoneId], references: [id])
  zoneId      String?         @db.Uuid

  aiAnalysis  AiAnalysis?
  assignments Assignment[]

  // SLA tracking
  assignedAt  DateTime?
  resolvedAt  DateTime?

  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([latitude, longitude])
  @@map("complaints")
}

model AiAnalysis {
  id                   String    @id @default(uuid()) @db.Uuid

  complaint             Complaint @relation(fields: [complaintId], references: [id])
  complaintId           String    @unique @db.Uuid

  departmentPrediction  String
  severityScore         Int       // 1–10
  locationSensitivity   Int       // 1–10
  publicRiskScore       Int       // 1–10
  envImpactScore        Int       // 1–10

  priorityScore         Float
  priorityLevel         Priority

  analyticsTags         String[]
  confidence            Float     // 0–1

  rawAiOutput           Json?

  createdAt            DateTime  @default(now())

  @@map("ai_analysis")
}

model Assignment {
  id            String      @id @default(uuid()) @db.Uuid

  complaint     Complaint   @relation(fields: [complaintId], references: [id])
  complaintId   String      @db.Uuid

  department    Department  @relation(fields: [departmentId], references: [id])
  departmentId  String      @db.Uuid

  assignedAt    DateTime    @default(now())
  notes         String?

  @@index([complaintId])
  @@index([departmentId])
  @@map("assignments")
}